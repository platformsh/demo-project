name: Node.js CI

on:
  pull_request:
    branches:
      - main

env:
  MAX_HIGH: 0
  MAX_CRITICAL: 0

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # These versions match Upsun support
        #   Node.js: https://docs.upsun.com/languages/nodejs.html#supported-versions
        node-version: [18.x, 20.x, 21.x]
        #   Python: https://docs.upsun.com/languages/python.html#supported-versions
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      ################################################################################################
      # A. Setup workflow.
      - name: "1. Retrieve local files."
        uses: actions/checkout@v4
        with:
            ref: ${{ github.event.pull_request.head.sha }}
      - name: "2. Set up Node.js."
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: "3. Python."
        uses: actions/setup-python@v4 
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'   # harmless even though we'll use uv

      ################################################################################################
      # B. Prettify, lint, and test repo.
      - name: "4. Preparing"
        run: |
          echo "::notice::Running react-scripts tests."
          export CI=true

          # Install Bun (CI-friendly; avoids adding an extra setup step)
          curl -fsSL https://bun.sh/install | bash
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
          bun --version

          # Install uv (fast Python resolver/installer)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
          uv --version

          bun install
      - name: "5. Verifying backend code is pretty"
        run: bun run prettier:backend
      - name: "6. Verifying frontend code is pretty"
        run: bun run prettier:frontend
      - name: "7. Linting frontend"
        run: bun run lint:frontend
      - name: "8. Run Frontend tests"
        run: bun run test:frontend
      - name: "9. Run Backend linting"
        run: bun run lint:backend

      ################################################################################################
      # C. Ensure no vulnerabilities.
      - name: "10. Test: there should be no Python vulnerabilities."
        run: |
          echo "::notice::Checking for vulnerabilities in backend Python app dependencies."
          bun run test:backend
      - name: "11. Test: there should be no HIGH Node.js vulnerabilities."
        run: |
          echo "::notice::Checking HIGH vulnerabilities (bun audit)."
          cd frontend
          export CI=true
          bun audit --audit-level=high
      - name: "12. Test: there should be no CRITICAL Node.js vulnerabilities."
        run: |
          echo "::notice::Checking CRITICAL vulnerabilities (bun audit)."
          cd frontend
          export CI=true
          bun audit --audit-level=critical
